## اتصال OTP به تابان‌اس‌ام‌اس

این سند مسیر تکمیل احراز هویت با پیامک را طبق ساختار فعلی پروژه `tamirban1` (Next.js + MongoDB) مشخص می‌کند. هدف این است که ارسال و تأیید کد یک‌بارمصرف (OTP) به جای حالت تست ثابت `0000`، از طریق سرویس تابان‌اس‌ام‌اس انجام شود.

### 1. وضعیت فعلی پروژه

- مسیر درخواست OTP در `app/api/auth/otp/request/route.ts` و سرویس آن در `lib/services/otp.service.ts` پیاده‌سازی شده و کد ثابت تولید می‌کند.
- هش و مدیریت محدودیت تلاش‌ها در دیتابیس انجام می‌شود؛ فقط ارسال پیامک واقعی و مدیریت پاسخ سرویس باقی مانده است.
- متغیرهای `.env.example` هنوز مقدار یا کلید سرویس پیامکی ندارند.

### 2. اطلاعات مورد نیاز از تابان‌اس‌ام‌اس

لطفاً پیش از شروع توسعه اطلاعات زیر را از پنل یا مستندات تابان جمع‌آوری کنید:

1. **اطلاعات احراز هویت**  
   - نام کاربری وب‌سرویس یا `apiKey`  
   - رمز عبور/توکن یا ترکیب Username+Password لازم برای درخواست‌ها  
   - در صورت وجود، `secretKey` یا پارامترهای تکمیلی
2. **آدرس‌های پایه API**  
   - `baseUrl` برای ارسال SMS (مثال: `https://api.tabansms.com/...`)  
   - مسیر دقیق Endpoint ارسال OTP یا سرویس عمومی ارسال پیامک  
   - در صورت نیاز Endpoint استعلام تحویل (Delivery Report)
3. **خط خدماتی و الگوی پیامک**  
   - شماره خط یا `senderNumber` مجاز برای ارسال OTP  
   - شناسه الگو/پترن (Pattern Code) در صورت استفاده از سرویس Pattern/Lookup  
   - متن نهایی پیام (با متغیر جایگزینی کد OTP)
4. **محدودیت‌ها و پیکربندی**  
   - سقف نرخ ارسال (Rate Limit) و فاصله زمانی مجاز برای هر شماره  
   - ساعت‌های مجاز ارسال و محدودیت اپراتور  
   - کدهای خطا، ساختار پاسخ و معنی آن‌ها  
   - زمان نگهداری گزارش‌ها در سامانه (برای مانیتورینگ)
5. **محیط تست**  
   - وجود environment تست یا شماره‌های تستی  
   - راهنمایی برای شبیه‌سازی ارسال موفق/ناموفق در محیط توسعه

اگر مستندات عمومی در دسترس است، پیوست آن به این مخزن (در مسیر `docs/sms/`) یا اشتراک آدرس آن مفید خواهد بود.

### 3. تغییرات پیشنهادی در پروژه

1. **تعریف متغیرهای محیطی**
   - افزودن کلیدهای زیر به `.env.example`:  
     ```
     TABAN_SMS_BASE_URL=
     TABAN_SMS_USERNAME=
     TABAN_SMS_PASSWORD=
     TABAN_SMS_SENDER_NUMBER=
     TABAN_SMS_PATTERN_ID=
     ```
     (مطابق اطلاعات واقعی تکمیل شوند؛ نام‌ها در صورت نیاز با قالب رسمی مستندات هماهنگ می‌گردد.)
2. **ایجاد کلاینت سرویس SMS**
   - فایل جدید مثلاً `lib/vendors/taban-sms.ts` با توابع:
     - `sendOtpSms({ phone, code })`
     - مدیریت پاسخ و خطاهای عمومی/خاص
   - استفاده از `fetch` یا `axios` با timeout مناسب و Retry محدود.
3. **اتصال به سرویس OTP**
   - در `lib/services/otp.service.ts` پس از تولید و ذخیره کد:
     - جایگزینی بلوک فعلی که `code` را برمی‌گرداند با فراخوانی `sendOtpSms`.
     - عدم بازگرداندن کد در پاسخ API (در Production).
   - پیاده‌سازی مدیریت خطا (در صورت شکست ارسال، پیام مناسب به کاربر و عدم ذخیره کد).
4. **ثبت لاگ و مانیتورینگ**
   - افزودن لاگ ساختاریافته (مثلاً با `console.error` یا سرویس لاگینگ) برای شکست ارسال.
   - امکان ذخیره وضعیت ارسال در کالکشن `SMSLog` برای پیگیری.
5. **تست و اعتبارسنجی**
   - نوشتن تست واحد برای سرویس ارسال (با Mock)  
   - ارائه سناریوی Postman برای درخواست/تأیید OTP و بررسی پاسخ موفق/ناموفق  
   - تست دستی با شماره واقعی بعد از فعال‌سازی خط خدماتی

### 4. روند اجرا

1. **جمع‌آوری اطلاعات** → تکمیل بخش 2.  
2. **به‌روزرسانی مستندات** → افزودن اطلاعات به `.env.example` و `docs/authentication-plan.md`.  
3. **پیاده‌سازی فنی** → ایجاد کلاینت، به‌روزرسانی سرویس OTP، نوشتن لاگ و تست.  
4. **بررسی QA** → اجرای سناریوهای OTP در محیط توسعه و دریافت تأیید کارفرما.  
5. **استقرار** → اضافه کردن متغیرهای محیطی به سرور سی‌پنل و مانیتورینگ.

### 5. مستندات یا اطلاعات مکمل

- در صورت وجود PDF یا آدرس دقیق مستندات تابان، لطفاً آن را ارسال کنید تا پارامترها و نوع احراز هویت دقیقا مطابق استاندارد آن‌ها اعمال شود.
- اگر سرویس Pattern نیازمند ثبت قالب خاصی است، محتوای پیام و متغیرهای آن را مشخص کنید (مثلاً «کد ورود شما: {otp}»).

---

پس از دریافت اطلاعات بند 2، می‌توان توسعه را آغاز کرد و بخش‌های مربوطه در `todo.md` (مثلاً فاز 5 و فاز 2) را به‌روزرسانی نمود.

