# ุฑุงูููุง ุงุชุตุงู OTP ุจู ุชุงุจุงู ุงุณโุงูโุงุณ (IPPanel Edge API)

ุงู ุณูุฏ ูุณุฑ ุชฺฉูู ุงุญุฑุงุฒ ููุช ุจุง ูพุงูฺฉ ุฑุง ุทุจู ุณุงุฎุชุงุฑ ูุนู ูพุฑูฺู `tamirban1` (Next.js + MongoDB) ูุดุฎุต ูโฺฉูุฏ. ูุฏู ุงู ุงุณุช ฺฉู ุงุฑุณุงู ู ุชุฃุฏ ฺฉุฏ ฺฉโุจุงุฑูุตุฑู (OTP) ุจู ุฌุง ุญุงูุช ุชุณุช ุซุงุจุช `0000`ุ ุงุฒ ุทุฑู ุณุฑูุณ ุชุงุจุงู ุงุณโุงูโุงุณ (IPPanel Edge API) ุงูุฌุงู ุดูุฏ.

## ๐ ูุณุชูุฏุงุช ูุฑุฌุน

- **ุขุฏุฑุณ ูุณุชูุฏุงุช:** https://ippanelcom.github.io/Edge-Document/docs/
- **Base URL API:** `https://edge.ippanel.com/v1`
- **ุฑูุด ุงุญุฑุงุฒ ููุช:** API Key ุฏุฑ ูุฏุฑ `Authorization`
- **ฺฉูุฏ API ููุฌูุฏ:** โ (ุฏุฑ `.env.example` ุชูุธู ุดุฏู)

## 1. ูุถุนุช ูุนู ูพุฑูฺู

โ **ุงูุฌุงู ุดุฏู:**
- ูุณุฑ ุฏุฑุฎูุงุณุช OTP ุฏุฑ `app/api/auth/otp/request/route.ts` ูพุงุฏูโุณุงุฒ ุดุฏู
- ุณุฑูุณ OTP ุฏุฑ `lib/services/otp.service.ts` ุจุง ฺฉุฏ ุซุงุจุช `0000` ฺฉุงุฑ ูโฺฉูุฏ
- ูุด OTP ุจุง `bcrypt` ู ูุฏุฑุช ูุญุฏูุฏุช ุชูุงุดโูุง ุฏุฑ ุฏุชุงุจุณ ุงูุฌุงู ูโุดูุฏ
- ุณุงุฎุชุงุฑ `SMSLog` ุฏุฑ ุฏุชุงุจุณ ุจุฑุง ุซุจุช ูุงฺฏ ุงุฑุณุงูโูุง ุขูุงุฏู ุงุณุช
- ูุชุบุฑูุง ูุญุท ุฏุฑ `.env.example` ุชูุธู ุดุฏูโุงูุฏ

โณ **ุจุงูโูุงูุฏู:**
- ุงุฌุงุฏ ฺฉูุงูุช ุชุงุจุงู ุงุณโุงูโุงุณ ุจุฑุง ุงุฑุณุงู ูุงูุน SMS
- ุงุชุตุงู ุณุฑูุณ OTP ุจู ฺฉูุงูุช ุชุงุจุงู
- ุชุณุช ุงุฑุณุงู ูุงูุน ู ูุฏุฑุช ุฎุทุงูุง

## 2. ุงุทูุงุนุงุช ููุฑุฏ ูุงุฒ ุงุฒ ูพูู ุชุงุจุงู

ุจุฑุง ุชฺฉูู ูพุงุฏูโุณุงุฒุ ูุทูุงู ุงุทูุงุนุงุช ุฒุฑ ุฑุง ุงุฒ ูพูู ฺฉุงุฑุจุฑ ุชุงุจุงู ุงุณโุงูโุงุณ ุฏุฑุงูุช ฺฉูุฏ:

### โ ุงุทูุงุนุงุช ููุฌูุฏ
- โ **API Key:** `YTA1Njg1ZjQtOTQ5ZC00MjJmLWI4NWUtOTUwMjQ3MTU1MTA5YzkwZTk1YmRiNGNmMmVlZDkwNzMyMjgzN2I5NDgyNjU=`
- โ **Base URL:** `https://edge.ippanel.com/v1`

### โณ ุงุทูุงุนุงุช ููุฑุฏ ูุงุฒ
1. **ุดูุงุฑู ุฎุท ุฎุฏูุงุช (Sender Number)**
   - ุดูุงุฑู ุฎุท ูุฌุงุฒ ุจุฑุง ุงุฑุณุงู OTP
   - ุงุฒ ุจุฎุด Numbers ุฏุฑ ูพูู ูุงุจู ูุดุงูุฏู ุงุณุช
   - ุจุงุฏ ุฏุฑ ูุชุบุฑ `TABAN_SMS_SENDER_NUMBER` ูุฑุงุฑ ฺฏุฑุฏ

2. **Endpoint ุงุฑุณุงู SMS**
   - ูุณุฑ ุฏูู API ุจุฑุง ุงุฑุณุงู ูพุงูฺฉ (ูุซูุงู `/sms/send` ุง `/messages/send`)
   - ุจุฑุฑุณ ูุณุชูุฏุงุช ุจุฎุด "Send SMS" ุฏุฑ https://ippanelcom.github.io/Edge-Document/docs/send
   - ุณุงุฎุชุงุฑ ุฏุฑุฎูุงุณุช (Body parameters: recipient, message, sender)

3. **ูุญุฏูุฏุชโูุง ู ููุงูู**
   - Rate Limit (ุชุนุฏุงุฏ ุฏุฑุฎูุงุณุช ูุฌุงุฒ ุฏุฑ ุฏููู/ุณุงุนุช)
   - ูุญุฏูุฏุช ุทูู ูพุงู (ุชุนุฏุงุฏ ฺฉุงุฑุงฺฉุชุฑ)
   - ูุญุฏูุฏุช ุณุงุนุช ุงุฑุณุงู (ุฏุฑ ุตูุฑุช ูุฌูุฏ)
   - ฺฉุฏูุง ุฎุทุง ู ูุนู ุขูโูุง

4. **ุงูฺฏู ูพุงูฺฉ (Pattern) - โ ูุนุงู ุดุฏู**
   - โ **Pattern Code:** `0wopnv45vvw7mss` (ุฏุฑ `.env.example` ุชูุธู ุดุฏู)
   - โ๏ธ **ุณุงุฎุชุงุฑ ูุชุบุฑูุง ุงูฺฏู:** ุจุงุฏ ุงุฒ ูพูู ุชุงุจุงู ุจุฑุฑุณ ุดูุฏ (ุงุญุชูุงูุงู `{code}` ุง `{otp}`)
   - โ **ูพุงุฏูโุณุงุฒ:** ฺฉูุงูุช ุชุงุจุงู ุจุฑุง ุงุณุชูุงุฏู ุงุฒ Pattern ุจูโุฑูุฒุฑุณุงู ุดุฏู ุงุณุช

## 3. ุชุบุฑุงุช ูู ููุฑุฏ ูุงุฒ

### 3.1. ุงุฌุงุฏ ฺฉูุงูุช ุชุงุจุงู ุงุณโุงูโุงุณ

**ูุงู ุฌุฏุฏ:** `lib/vendors/taban-sms.ts`

```typescript
// ุณุงุฎุชุงุฑ ูพุดููุงุฏ
export interface TabaanSmsConfig {
  baseUrl: string;
  apiKey: string;
  senderNumber: string;
}

export interface SendSmsParams {
  phone: string; // ุดูุงุฑู ฺฏุฑูุฏู (ุจุง ูุฑูุช 09123456789)
  message: string; // ูุชู ูพุงูฺฉ
}

export interface TabaanSmsResponse {
  success: boolean;
  messageId?: string;
  error?: string;
}

export async function sendSms(params: SendSmsParams): Promise<TabaanSmsResponse> {
  // ูพุงุฏูโุณุงุฒ ุจุง fetch
  // ุงุณุชูุงุฏู ุงุฒ API Key ุฏุฑ ูุฏุฑ Authorization
  // ูุฏุฑุช ุฎุทุงูุง ู retry
}
```

### 3.2. ุจูโุฑูุฒุฑุณุงู ุณุฑูุณ OTP

**ูุงู:** `lib/services/otp.service.ts`

ุชุบุฑุงุช:
- ูพุณ ุงุฒ ุชููุฏ ฺฉุฏ OTPุ ูุฑุงุฎูุงู `sendSms` ุจู ุฌุง ุจุงุฒฺฏุฑุฏุงูุฏู ฺฉุฏ
- ุฏุฑ ุตูุฑุช ููููุช ุงุฑุณุงูุ ุซุจุช ูุงฺฏ ุฏุฑ `SMSLog` ุจุง ูุถุนุช `QUEUED`
- ุฏุฑ ุตูุฑุช ุฎุทุงุ ุซุจุช ูุงฺฏ ุจุง ูุถุนุช `FAILED` ู throw ฺฉุฑุฏู ุฎุทุง
- ุฏุฑ ูุญุท Productionุ ุญุฐู ุจุงุฒฺฏุฑุฏุงูุฏู ฺฉุฏ ุงุฒ ูพุงุณุฎ API

### 3.2.1. ูพุดุชุจุงู ุงุฒ Pattern SMS โ

**ูุงู:** `lib/vendors/taban-sms.ts`

**ุชุบุฑุงุช ุงูุฌุงู ุดุฏู:**
- โ ุงูุฒูุฏู ูุชุบุฑ ูุญุท `TABAN_SMS_PATTERN_CODE=0wopnv45vvw7mss` ุจู `.env.example`
- โ ุจูโุฑูุฒุฑุณุงู `SendSmsParams` ุจุฑุง ูพุดุชุจุงู ุงุฒ `patternCode` ู `patternValues`
- โ ุจูโุฑูุฒุฑุณุงู ุชุงุจุน `sendSms` ุจุฑุง ูพุดุชุจุงู ุงุฒ Pattern API:
  - ุงฺฏุฑ `patternCode` ู `patternValues` ููุฌูุฏ ุจุงุดูุฏุ ุงุฒ Pattern API ุงุณุชูุงุฏู ูโุดูุฏ
  - ุฏุฑ ุบุฑ ุงู ุตูุฑุชุ ุงุฒ ุฑูุด ูุฏู (ูุชู ูุณุชูู) ุงุณุชูุงุฏู ูโุดูุฏ
- โ ุจูโุฑูุฒุฑุณุงู ุชุงุจุน `sendOtpSms`:
  - ุฎูุงูุฏู `TABAN_SMS_PATTERN_CODE` ุงุฒ ูุชุบุฑูุง ูุญุท
  - ุงุณุชูุงุฏู ุงุฒ Pattern ุงฺฏุฑ ููุฌูุฏ ุจุงุดุฏ
  - Fallback ุจู ุฑูุด ูุฏู ุงฺฏุฑ Pattern ููุฌูุฏ ูุจุงุดุฏ

**ุณุงุฎุชุงุฑ Pattern API:**
```typescript
{
  sending_type: "webservice",
  from_number: "3000505",
  pattern_code: "0wopnv45vvw7mss",
  pattern_values: {
    code: "1234" // ูุงู ูุชุบุฑ ุจุงุฏ ุงุฒ ูพูู ุชุงุจุงู ุจุฑุฑุณ ุดูุฏ (ููฺฉู ุงุณุช "otp" ุจุงุดุฏ)
  },
  params: {
    recipients: ["09123456789"]
  }
}
```

**ูฺฉุชู ููู:** ูุงู ูุชุบุฑ Pattern (ูุซูุงู `code` ุง `otp`) ุจุงุฏ ุงุฒ ูพูู ุชุงุจุงู ุจุฑุฑุณ ุดูุฏ. ุฏุฑ ุญุงู ุญุงุถุฑ ุงุฒ `code` ุงุณุชูุงุฏู ุดุฏู ุงุณุช.

### 3.3. ุซุจุช ูุงฺฏ ุงุฑุณุงู

**ุงุณุชูุงุฏู ุงุฒ:** `lib/repositories/sms-logs.repository.ts`

ูพุณ ุงุฒ ูุฑ ุฏุฑุฎูุงุณุช ุงุฑุณุงู:
- ุงุฌุงุฏ ุฑฺฉูุฑุฏ `SMSLog` ุจุง:
  - `recipient`: ุดูุงุฑู ฺฏุฑูุฏู
  - `message`: ูุชู ูพุงู (ุจุฏูู ููุงุด ฺฉุฏ OTP ุฏุฑ ูุงฺฏ)
  - `status`: `QUEUED` โ ุจุนุฏุงู ุจุง webhook ุง polling ุจู `DELIVERED`/`FAILED` ุชุจุฏู ุดูุฏ
  - `provider`: `"TABAN_SMS"`
  - `providerMessageId`: ุดูุงุณู ูพุงู ุงุฒ ูพุงุณุฎ API ุชุงุจุงู

### 3.4. ูุฏุฑุช ุฎุทุงูุง

ุฎุทุงูุง ุงุญุชูุงู:
- **ุดุจฺฉู:** Timeoutุ ุนุฏู ุฏุณุชุฑุณ ุจู API
- **ุงุญุฑุงุฒ ููุช:** API Key ูุงูุนุชุจุฑ ุง ูููุถ ุดุฏู
- **ุงุนุชุจุงุฑ:** ููุฌูุฏ ูุงฺฉุงู ุฏุฑ ุญุณุงุจ ุชุงุจุงู
- **ุงุนุชุจุงุฑุณูุฌ:** ุดูุงุฑู ฺฏุฑูุฏู ูุงูุนุชุจุฑุ ูุชู ุฎุงู
- **Rate Limit:** ุชุนุฏุงุฏ ุฏุฑุฎูุงุณุช ุจุด ุงุฒ ุญุฏ

ุจุฑุง ูุฑ ุฎุทุง:
- ุซุจุช ุฏุฑ `SMSLog` ุจุง ูุถุนุช `FAILED`
- ุจุงุฒฺฏุฑุฏุงูุฏู ูพุงู ุฎุทุง ููุงุณุจ ุจู ฺฉุงุฑุจุฑ (ุจุฏูู ุงูุดุง ุฌุฒุฆุงุช ูู)
- Log ฺฉุฑุฏู ุฌุฒุฆุงุช ุฎุทุง ุฏุฑ console ุจุฑุง ุฏุจุงฺฏ

## 4. ฺฺฉโูุณุช ูพุงุฏูโุณุงุฒ

ูุฑุงุญู ฺฉุงุฑ ุฏุฑ `todo.md` (ูุงุฒ 5) ุจูโุตูุฑุช ุฒุฑ ูุดุฎุต ุดุฏู:

- [ ] ุงูุฒูุฏู ูุชุบุฑูุง ูุญุท ุชุงุจุงู ุงุณโุงูโุงุณ ุจู `.env.example` โ (ุงูุฌุงู ุดุฏ)
- [ ] ุงุฌุงุฏ ฺฉูุงูุช ุชุงุจุงู ุงุณโุงูโุงุณ ุฏุฑ `lib/vendors/taban-sms.ts`
- [ ] ุจุฑุฑุณ ูุณุชูุฏุงุช API ุชุงุจุงู ุจุฑุง endpoint ุงุฑุณุงู SMS
- [ ] ูพุงุฏูโุณุงุฒ `sendOtpSms(phone, code)` ุจุง API Key
- [ ] ุจูโุฑูุฒุฑุณุงู `lib/services/otp.service.ts` ุจุฑุง ูุฑุงุฎูุงู ุณุฑูุณ ูุงูุน
- [ ] ูุฏุฑุช ุฎุทุงูุง ุงุฑุณุงู SMS ู ูพุงูโูุง ููุงุณุจ
- [ ] ุซุจุช ูุงฺฏ ุงุฑุณุงู ุฏุฑ ฺฉุงูฺฉุดู `SMSLog`
- [ ] ุชุณุช ุงุฑุณุงู ูุงูุน ุจุง ุดูุงุฑู ููุจุงู
- [ ] ุญุฐู ุจุงุฒฺฏุฑุฏุงูุฏู ฺฉุฏ OTP ุงุฒ ูพุงุณุฎ API ุฏุฑ Production

## 5. ุชุณุช ู ุงุนุชุจุงุฑุณูุฌ

### 5.1. ุชุณุช ูุงุญุฏ
- Mock ฺฉุฑุฏู ฺฉูุงูุช ุชุงุจุงู ุจุฑุง ุชุณุช ุณุฑูุณ OTP
- ุชุณุช ุณูุงุฑููุง ูููู/ูุงูููู ุงุฑุณุงู

### 5.2. ุชุณุช ฺฉูพุงุฑฺฺฏ
- ุฏุฑุฎูุงุณุช OTP ุงุฒ ุทุฑู Postman ุง UI
- ุจุฑุฑุณ ุฏุฑุงูุช ูพุงูฺฉ ุฑู ุดูุงุฑู ูุงูุน
- ุจุฑุฑุณ ุซุจุช ูุงฺฏ ุฏุฑ ุฏุชุงุจุณ
- ุชุณุช ุชุฃุฏ ฺฉุฏ ู ูุฑูุฏ ูููู

### 5.3. ุชุณุช ุฎุทุง
- ุชุณุช ุจุง API Key ูุงูุนุชุจุฑ
- ุชุณุช ุจุง ุดูุงุฑู ูุงูุนุชุจุฑ
- ุชุณุช ุจุง ููุฌูุฏ ูุงฺฉุงู (ุฏุฑ ุตูุฑุช ุงูฺฉุงู)

## 6. ูุณุชูุฏุงุช ุชฺฉูู

ูพุณ ุงุฒ ุชฺฉูู ูพุงุฏูโุณุงุฒ:
- ุจูโุฑูุฒุฑุณุงู `docs/authentication-plan.md` ุจุง ุฌุฒุฆุงุช ุชุงุจุงู
- ุงูุฒูุฏู ูุซุงูโูุง Postman ุจุฑุง ุชุณุช API
- ูุณุชูุฏุณุงุฒ ฺฉุฏูุง ุฎุทุง ู ุฑุงูโุญูโูุง ุฑุงุฌ

---

**ูฺฉุชู ููู:** 
- ูุจู ุงุฒ ุงุณุชูุฑุงุฑ ุฏุฑ Productionุ ุญุชูุงู `TABAN_SMS_SENDER_NUMBER` ุฑุง ุงุฒ ูพูู ุชุงุจุงู ุฏุฑุงูุช ู ุฏุฑ `.env` ุณุฑูุฑ ุชูุธู ฺฉูุฏ.
- โ `TABAN_SMS_PATTERN_CODE` ุชูุธู ุดุฏู ุงุณุช: `0wopnv45vvw7mss`
- โ๏ธ **ูุงุฒ ุจู ุจุฑุฑุณ:** ูุงู ูุชุบุฑ Pattern (ูุซูุงู `code` ุง `otp`) ุจุงุฏ ุงุฒ ูพูู ุชุงุจุงู ุจุฑุฑุณ ุดูุฏ ู ุฏุฑ ุตูุฑุช ูุงุฒ ุฏุฑ ฺฉุฏ ุจูโุฑูุฒุฑุณุงู ุดูุฏ.
