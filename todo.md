# چک‌لیست جامع اجرای پروژه «تعمیربان» (شروع از صفر)

این سند برای شروع پروژه جدید در محیط Next.js + TypeScript + Tailwind تدوین شده است و باید در مخزن تازه‌ ایجادشده قرار گیرد. همه آیتم‌ها در حالت انجام‌نشده هستند تا بتوان روند را مرحله‌به‌مرحله دنبال کرد.

## فاز 0 — هماهنگی و پیش‌نیازها
- [ ] تایید محدوده و خروجی‌ها بر اساس `explaination.md`
- [ ] مشخص کردن نقش‌ها، زمان‌بندی و نحوه گزارش‌دهی
- [ ] انتخاب سرویس پیامکی و دریافت دسترسی‌ها (در صورت آماده نبودن، ثبت در لیست تعلیق)
- [ ] دریافت قالب فایل Excel برای Import مشتری‌ها از کارفرما
- [ ] هماهنگی با هاست سی‌پنل برای اجرای برنامه Node.js روی پورت 3124 و دسترسی به SSH/FTP

## فاز 1 — راه‌اندازی پروژه Next.js (Tailwind + TypeScript)
- [x] ساخت مخزن جدید و اجرای `npx create-next-app@latest tamirban --ts --tailwind`
- [x] پاک‌سازی نمونه‌ها و تعریف ساختار پوشه‌ها (`app/`, `lib/`, `modules/`, `postman/`, `public/`, `docs/`)
- [x] افزودن فونت «ایران یکان» در `public/fonts` و تعریف آن در `tailwind.config.ts`
- [x] تنظیم زبان فارسی و RTL در `app/layout.tsx` و `app/globals.css`
- [x] پیکربندی Theme پایه (رنگ‌ها، سایه‌ها، spacing) با Tailwind
- [ ] راه‌اندازی ESLint/Prettier و فعال‌سازی TypeScript strict mode
- [x] ایجاد `postman/README.md` برای آماده‌سازی کالکشن‌ها و مستندات API

## فاز 2 — تنظیمات محیطی و استقرار سی‌پنل
- [x] ایجاد `.env.example` با متغیرهای پایه (PORT=3124، NEXT_PUBLIC_SITE_URL، MONGODB_URI، SMS Provider)
- [x] پیاده‌سازی `server.js` برای اجرای Next.js روی پورت 3124 با `next start`
- [x] افزودن اسکریپت `start:server` به `package.json`
- [x] تست اجرای محلی با `node server.js`
- [x] نوشتن راهنمای استقرار در `docs/deployment-cpanel.md`

## فاز 3 — طراحی UI پایه با تایید مرحله‌ای
- [x] طراحی Layout اصلی (Header، Sidebar، Main) و نمایش به کارفرما برای تایید
- [x] تنظیم تایپوگرافی و مقیاس فونت‌ها (فونت ایران یکان) و تایید
- [x] پیاده‌سازی UI صفحه ورود/OTP (بدون بک‌اند) و دریافت تایید
- [x] پیاده‌سازی UI صفحه داشبورد (بدون داده واقعی) و دریافت تایید
- [x] طراحی UI صفحات Customers، Marketers، Visits، Invoices، Settings (UI-only) و تایید تک‌به‌تک
  - [x] Customers: لیست، فیلتر و پنل جزئیات
  - [x] Marketers: لیست بازاریاب‌ها و کارت‌های وضعیت
  - [x] Visits: نقشه و جدول برنامه روزانه
  - [x] Invoices: جدول و پیش‌نمایش PDF
  - [x] Settings: تب‌بندی تنظیمات دسترسی و اعلان‌ها
- [ ] ساخت کتابخانه کامپوننت‌ها (Buttons، Inputs، Cards، Tables، Tabs، Modals)
- [ ] تست ریسپانسیو و RTL در هر مرحله پیش از اتصال به داده

## فاز 4 — مدل داده و اتصال MongoDB
- [x] تعریف Types/Interfaces برای User، Contact، Visit، Product، Invoice، SMSLog
- [x] راه‌اندازی اتصال به MongoDB با URI پروژه و تست سلامت اتصال
- [x] ایجاد لایه Repository/Service برای عملیات CRUD و فیلترها
- [ ] نوشتن تست‌های واحد برای سرویس‌ها (Jest یا Vitest)
- [x] مستندسازی ساختار داده در `docs/data-model.md`

## فاز 5 — احراز هویت و مدیریت نقش‌ها
- [x] پیاده‌سازی احراز هویت با شماره موبایل و OTP (حالت تست: کد ثابت بدون SMS واقعی)
- [ ] **ادغام تابان اس‌ام‌اس برای ارسال OTP واقعی**
  - [ ] افزودن متغیرهای محیطی تابان اس‌ام‌اس به `.env.example` (API_KEY، BASE_URL، SENDER_NUMBER)
  - [ ] ایجاد کلاینت تابان اس‌ام‌اس در `lib/vendors/taban-sms.ts` با توابع ارسال SMS
  - [ ] بررسی مستندات API تابان برای endpoint ارسال SMS و ساختار درخواست/پاسخ
  - [ ] پیاده‌سازی `sendOtpSms(phone, code)` با استفاده از API Key در هدر Authorization
  - [ ] به‌روزرسانی `lib/services/otp.service.ts` برای فراخوانی سرویس واقعی به جای کد ثابت
  - [ ] مدیریت خطاهای ارسال SMS (شبکه، اعتبار، محدودیت نرخ) و پیام‌های مناسب به کاربر
  - [ ] ثبت لاگ ارسال در کالکشن `SMSLog` با وضعیت QUEUED/DELIVERED/FAILED
  - [ ] تست ارسال واقعی با شماره موبایل و بررسی دریافت پیامک
  - [ ] حذف بازگرداندن کد OTP از پاسخ API در محیط Production
- [x] هش کردن OTPها و رمزهای یک‌بارمصرف با `bcrypt`
- [x] صدور و مدیریت توکن‌های دسترسی/تازه‌سازی با `JWT`
- [x] مستندسازی گزینه جایگزین (NextAuth Credentials) و دلیل انتخاب رویکرد JWT
- [ ] صفحه مدیریت کاربران: ایجاد دستی بازاریاب، فعال/غیرفعال، تعیین نقش و دسترسی اختصاصی
- [ ] پیاده‌سازی Role-Based Access Control در سطح API و UI
- [ ] ثبت لاگ ورود/خروج و رویدادهای امنیتی

## فاز 6 — ماژول‌های اصلی پنل وب
- [ ] **Customers:** CRUD کامل، جستجو و فیلتر، Import از Excel، مدیریت آدرس/لوکیشن، تاریخچه تعاملات
- [ ] **Marketers:** مدیریت حساب بازاریاب‌ها، تعیین سطح دسترسی، وضعیت فعال/غیرفعال
- [ ] **Catalog:** مدیریت محصولات، قیمت، دسته‌بندی و تصاویر
- [ ] **Visits:** نمایش روی نقشه نشان، ثبت ویزیت، یادداشت، پیگیری و نیازسنجی
- [ ] **Invoices:** ایجاد/ویرایش، محاسبه، وضعیت‌ها، تولید PDF داخلی و دانلود
- [ ] **SMS Center:** ارسال پیامک فعال‌سازی و تبلیغاتی، لیست ارسال‌ها و وضعیت
- [ ] **Dashboard:** نمایش KPI، نمودارها، کارت‌های وضعیت و فیلتر زمانی
- [ ] ارائه دموی هر ماژول به کارفرما پس از اتصال داده برای تایید نهایی UI/UX

## فاز 7 — API RESTful و Postman
- [ ] طراحی ساختار Endpointها، متدها و پاسخ‌ها برای همه ماژول‌ها
- [ ] پیاده‌سازی Route Handlerهای Next.js با Middlewareهای احراز هویت، Validation، Rate Limit
- [ ] ساخت Postman Collection با مثال درخواست/پاسخ
- [ ] ایجاد Postman Environment (پایه URL، توکن، شماره تست OTP)
- [ ] افزودن تست‌های Postman (pre-request و test scripts)
- [ ] اشتراک‌گذاری مستندات و کالکشن با تیم Flutter/Android

## فاز 8 — آماده‌سازی انتقال به Flutter/Android
- [ ] جمع‌آوری دارایی‌های UI نهایی (تصاویر استاتیک صفحات، Style Guide، Tokenهای Tailwind)
- [ ] تولید راهنمای `docs/flutter-handoff.md` شامل معماری، قراردادهای API، نقش‌ها و سناریوها
- [ ] استخراج نمونه درخواست/پاسخ Postman و الحاق به راهنما
- [ ] تدوین چک‌لیست فازبندی شده توسعه Flutter (Bootstrap → Auth → ماژول‌ها → تست → انتشار)
- [ ] مستندسازی نیازهای امنیتی موبایل (ذخیره JWT/Refresh، مدیریت انقضا، Re-auth)
- [ ] تهیه پرامپت‌ها یا توضیحات استاتیک برای انتقال به تیم طراحی/توسعه موبایل

## فاز 9 — اپلیکیشن Flutter/Android (پس از تحویل راهنمای انتقال)
- [ ] ایجاد پروژه Flutter جدید و تنظیمات اولیه
- [ ] اتصال به REST API (حالت تست OTP) و پیاده‌سازی مدیریت JWT/Refresh Token
- [ ] پیاده‌سازی صفحات Auth، Dashboard، Customers، Visits، Invoices مطابق راهنمای وب
- [ ] ادغام Push Notification و مدیریت Device Token
- [ ] تست عملکرد و UI روی دستگاه‌های اندرویدی هدف
- [ ] همگام‌سازی راهنمای انتقال در صورت اعمال تغییر در تجربه کاربری

## فاز 10 — تضمین کیفیت و امنیت
- [ ] پوشش تست‌های واحد و Integration برای وب و API
- [ ] اجرای تست‌های End-to-End (Playwright یا Cypress)
- [ ] تست دستی در موبایل، تبلت و دسکتاپ (RTL + PWA)
- [ ] بررسی امنیتی (Rate Limit، Validation، Sanitization، مدیریت session)
- [ ] آزمون کارایی (پاسخ API، ایجاد PDF، Import/Export Excel)
- [ ] تهیه ویدئوی آموزشی و راهنمای کاربری
- [ ] ممیزی پایگاه داده و ارتباطات (بررسی روابط، ایندکس‌ها، محدودیت‌ها و کفایت داده)
- [ ] بازبینی سناریوهای CRM انتها به انتها (ایجاد کاربر → ویزیت → پیش‌فاکتور → گزارش)

## فاز 11 — استقرار و تحویل
- [ ] ساخت Build نهایی (`next build`)
- [ ] استقرار روی سی‌پنل با `node server.js` و پورت 3124
- [ ] اتصال دامنه `https://tamirban1.ir/` به برنامه Node.js (تنظیمات ریورس پراکسی یا Application Manager)
- [ ] تنظیم و تست SSL روی دامنه
- [ ] قرار دادن `.env` نهایی روی سرور (عدم انتشار در مخزن)
- [ ] تست نهایی روی محیط واقعی برای همه سناریوهای کلیدی
- [ ] تحویل Postman Collection و Environment به تیم اندروید
- [ ] توافق بر برنامه پشتیبانی و به‌روزرسانی‌های آینده

## پیگیری و مستندسازی
- [ ] به‌روزرسانی منظم `todo.md` و `explaination.md` با پیشرفت واقعی
- [ ] ثبت تصمیمات معماری در `docs/architecture.md`
- [ ] نگهداری CHANGELOG برای نسخه‌های مهم
- [ ] دیدار/جلسه دوره‌ای با کارفرما جهت تایید UI و عملکرد
- [ ] آماده‌سازی چک‌لیست تحویل نهایی برای اطمینان از پوشش همه موارد

## رفع فوری — احیای استایل Tailwind
- [x] تصمیم نهایی در مورد مسیر مهاجرت Tailwind (بازگشت به v3 یا تکمیل v4)
- [x] به‌روزرسانی وابستگی‌ها و پیکربندی مطابق مسیر انتخاب‌شده
  - [ ] بازگشت به v3: حذف بسته‌های نسخه ۴، نصب `tailwindcss@^3`, `autoprefixer` و تنظیم مجدد `postcss.config`/`tailwind.config`
  - [x] تکمیل مهاجرت v4: نصب `@tailwindcss/cli`, به‌روزرسانی ورودی CSS (`@import "tailwindcss"`)، تنظیم اسکریپت‌های build/dev و اطمینان از اجرای CLI
- [x] اجرای `next build` یا `next dev` و بررسی خروجی CSS برای وجود utilityها (نمونه: `bg-white`, `rounded-3xl`)
- [x] تست دستی صفحات داشبورد و احراز هویت برای تایید بازگشت استایل‌ها

## وظایف فوری — تست اتصال دیتابیس و ورود OTP
- [x] اطمینان از مقداردهی متغیرهای محیطی (`MONGODB_URI`, `MONGODB_DB_NAME`, `JWT_SECRET`) در `.env.local`
- [x] پیاده‌سازی سرویس OTP ساده با `bcrypt` برای ذخیره کدهای یکبارمصرف و محدودیت تلاش‌ها
- [x] ایجاد API برای درخواست OTP و تأیید آن (ثبت کاربر در MongoDB در صورت نبود)
- [x] تولید و بازگرداندن JWT پس از تایید کد `0000` و ذخیره نشست در دیتابیس
- [x] سنجش اتصال با این سناریو: ثبت شماره آزمایشی، ارسال کد ثابت `0000`, دریافت پاسخ موفق از API و ورود از طریق فرانت‌اند
- [x] مستندسازی مراحل تست و ابزارهای Postman جهت استفاده مجدد

## فاز ادغام تابان اس‌ام‌اس — ثبت‌نام و لاگین با OTP واقعی
- [x] **مرحله 1: آماده‌سازی محیط و مستندات**
  - [x] افزودن متغیرهای محیطی تابان به `.env.example` (BASE_URL، API_KEY)
  - [x] دریافت شماره خط خدماتی (SENDER_NUMBER=3000505) از پنل تابان و افزودن به `.env.example`
  - [x] بررسی مستندات API تابان: https://ippanelcom.github.io/Edge-Document/docs/
  - [x] بررسی endpoint Webservice SMS: POST /api/send با sending_type="webservice"
  - [x] به‌روزرسانی `taban-sms-integration.md` با اطلاعات واقعی
- [x] **مرحله 2: پیاده‌سازی کلاینت تابان**
  - [x] ایجاد پوشه `lib/vendors/` در صورت عدم وجود
  - [x] ایجاد فایل `lib/vendors/taban-sms.ts` با تابع `sendSms(phone, message)` و `sendOtpSms(phone, code)`
  - [x] پیاده‌سازی احراز هویت با API Key در هدر `Authorization: {apiKey}`
  - [x] بررسی endpoint ارسال SMS از مستندات: POST `/api/send` با `sending_type="webservice"`
  - [x] پیاده‌سازی ساختار درخواست HTTP (POST) با body مناسب (from_number, message, recipients)
  - [x] تبدیل شماره‌ها به فرمت E.164 (+98...)
  - [x] Parse کردن پاسخ API و استخراج messageId یا کد خطا
  - [x] مدیریت خطاهای شبکه و timeout
- [x] **مرحله 3: اتصال به سرویس OTP**
  - [x] به‌روزرسانی `lib/services/otp.service.ts` در تابع `requestOtp`
  - [x] تولید کد OTP تصادفی (4 رقمی) به جای کد ثابت
  - [x] پس از تولید کد OTP، فراخوانی `sendOtpSms` با شماره و متن پیام
  - [x] ساخت متن پیام OTP: "کد ورود شما: {code}\n\nاین کد تا 5 دقیقه معتبر است."
  - [x] در صورت موفقیت ارسال: ثبت لاگ در `SMSLog` با وضعیت `QUEUED`
  - [x] در صورت خطا: ثبت لاگ با وضعیت `FAILED` و throw کردن خطا (در Production)
  - [x] حذف بازگرداندن کد OTP از پاسخ API در Production
  - [x] حفظ حالت تست با کد `0000` در محیط Development
- [x] **مرحله 4: مدیریت خطا و لاگ**
  - [x] پیاده‌سازی try-catch در `sendSms` برای خطاهای شبکه
  - [x] بررسی کدهای خطای API تابان و تبدیل به پیام‌های کاربرپسند
  - [x] ثبت جزئیات خطا در console برای دیباگ
  - [x] استفاده از `smsLogsRepository.create()` برای ثبت هر ارسال
  - [x] ذخیره `providerMessageId` (messageId) از پاسخ API در رکورد SMSLog
- [x] **مرحله 5: تست و اعتبارسنجی**
  - [x] به‌روزرسانی route handler برای حذف کد در Production
  - [ ] تست واحد برای `sendSms` با Mock Response (اختیاری)
  - [ ] تست یکپارچگی: درخواست OTP از طریق Postman یا UI
  - [ ] تست واقعی: ارسال OTP به شماره موبایل و بررسی دریافت
  - [ ] تست تأیید کد و ورود موفق پس از دریافت پیامک
  - [ ] تست خطا: API Key نامعتبر، شماره نامعتبر، موجودی ناکافی
  - [ ] بررسی ثبت لاگ‌ها در دیتابیس (SMSLog collection)
- [ ] **مرحله 6: بهینه‌سازی و مستندسازی**
  - [ ] افزودن Rate Limiting برای جلوگیری از ارسال بیش از حد
  - [ ] به‌روزرسانی `docs/authentication-plan.md` با جزئیات تابان
  - [ ] افزودن مثال‌های Postman برای تست API
  - [ ] مستندسازی کدهای خطا و راه‌حل‌های رایج در `taban-sms-integration.md`
  - [ ] بررسی و تست در محیط Production قبل از استقرار نهایی

## فاز بعدی — داینامیک کردن داده‌های اپلیکیشن
- [ ] همگام‌سازی مدل‌های Domain با طرح نهایی دیتابیس (شناسه‌ها، فیلدها، ایندکس‌ها، روابط)
- [ ] طراحی Seed اولیه برای هر کالکشن (Customers, Marketers, Visits, Invoices, SMSLogs)
- [ ] ساخت Repository/Serviceهای کامل با اعتبارسنجی ورودی و هندلینگ خطا
  - [x] Customers: CRUD، فیلتر/جستجو، تخصیص بازاریاب، تاریخچه تعامل
  - [ ] Marketers: CRUD، مدیریت نقش و وضعیت فعالیت، آمار عملکرد
  - [ ] Visits: برنامه‌ریزی، تغییر وضعیت، ثبت یادداشت و مختصات
  - [ ] Invoices: ایجاد و محاسبه جمع، تغییر وضعیت پرداخت، تولید PDF
  - [ ] Dashboard/Reports: محاسبه KPI و خروجی تجمیعی از داده‌ها
- [ ] طراحی API RESTful (Next Route Handlers) برای هر ماژول با 6 احراز هویت و Validation
  - [ ] Auth: ورود OTP، Refresh Token، خروج، محافظت از مسیرها
  - [x] Customers, Marketers, Visits, Invoices, Reports endpoints
  - [ ] Middleware برای JWT و Role-Based Access Control
- [ ] اتصال UI به داده‌های واقعی
  - [ ] تبدیل صفحه داشبورد به RSC/SSR با داده KPI و لیست‌ها
  - [x] فرم‌های Customers و Visits برای ایجاد/ویرایش با واکنش به خطا
  - [x] جدول‌ها و کارت‌ها با Pagination، فیلتر و Loading states
  - [ ] صفحه Invoices با جدول داینامیک و نمایش پیش‌نمایش PDF
  - [ ] پنل Settings و Reports با داده بک‌اند
- [ ] مدیریت نشست کاربر در فرانت‌اند (ذخیره JWT/Refresh، زمان‌بندی تمدید، خروج امن)
- [ ] پیاده‌سازی لاگ رویداد و رصد خطا (MongoDB یا ابزار بیرونی)
- [ ] نوشتن تست‌های واحد/Integration برای سرویس‌ها و API + سناریوی E2E حیاتی
- [ ] به‌روزرسانی مستندات Postman، README و `docs/` پس از هر ماژول
- [ ] تهیه اسکریپت راه‌اندازی (Seed/Import) و دستورالعمل استقرار داده واقعی


