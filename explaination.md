# توضیح جامع پروژه «تعمیربان» (شروع از صفر)

این سند مرجع اصلی برای آغاز توسعه پروژه تعمیربان است. تمامی اطلاعات، تکنولوژی‌ها، فازهای کاری و الزامات استقرار در سی‌پنل در اینجا جمع‌آوری شده تا بتوان پروژه را از صفر تا استقرار نهایی پیش برد.

## نمای کلی
- **هدف:** پیاده‌سازی یک سیستم CRM و مدیریت شبکه تعمیرگاه‌ها با سه سطح کاربری (مدیر کل، بازاریاب، مشتری).
- **خروجی‌ها:** وب‌اپ/PWA و پنل مدیریت (Next.js + Tailwind + TypeScript)، API RESTful مشترک، اپلیکیشن Flutter (Android)، مستندات Postman، تولید PDF پیش‌فاکتور، یکپارچگی با سرویس پیامکی.
- **وضعیت فعلی:** هنوز هیچ توسعه‌ای انجام نشده است و پروژه باید از ابتدا روی یک Next.js تازه (TypeScript + Tailwind) بالا بیاید.

## معماری فنی هدف
- **Front-end (Web/PWA/Admin):** Next.js 14+ با App Router، Tailwind CSS، فونت «ایران یکان»، RTL کامل، سازگاری با موبایل و دسکتاپ، پشتیبانی از PWA.
- **Backend:** API Routes و Route Handlers در Next.js به صورت RESTful، مدیریت session/توکن، پیاده‌سازی OTP.
- **Database:** MongoDB (استفاده از اتصال موجود روی سرور: `tamirban_tamirban1`).
- **Deployment:** اجرای Next.js روی سی‌پنل از طریق `server.js` روی پورت 3124، دامنه اصلی `https://tamirban1.ir/`.
- **Postman:** فولدر اختصاصی برای کالکشن‌ها و محیط‌ها.
- **DevOps:** فایل `.env.example` برای متغیرهای محیطی، شامل آدرس پایگاه داده و پورت سرور.

## الزامات کلیدی محصول
1. **احراز هویت با موبایل و OTP:** ارسال کد از طریق سرویس پیامکی (در فاز عملیاتی) + حالت تست بدون ارسال SMS. در پیاده‌سازی اصلی، استفاده از `bcrypt` برای ذخیره امن OTPها/کدهای ورود موقت و صدور `JWT` به عنوان توکن جلسه الزامی است.
2. **مدیریت نقش‌ها:** مدیر کل، مدیر مالی، بازاریاب، مشتری؛ امکان تنظیم دسترسی‌های اختصاصی و فعال/غیرفعال کردن کاربران.
3. **مدیریت مشتری‌ها:** افزودن دستی با نام/نام خانوادگی/شماره موبایل، ویرایش پروفایل کامل، ثبت لوکیشن، Import از Excel (قالب بعداً مشخص می‌شود).
4. **پیش‌فاکتور:** ایجاد، ذخیره و تولید PDF داخل سیستم، نگهداری آرشیو و امکان دانلود/ارسال.
5. **نقشه و ویزیت‌ها:** نمایش تعمیرگاه‌ها روی نقشه نشان، ثبت ویزیت، یادداشت و پیگیری.
6. **گزارش‌ها و آمار:** داشبورد مدیریتی، خروجی Excel/PDF برای اطلاعات کلیدی.

## فرآیند فرانت‌اند با تأیید مرحله‌ای
1. **Phase UI Foundation:** طراحی Layout پایه، ناوبری، وئت typography (فونت یکان)، تنظیم RTL، نمایش ماکاپ‌ها برای تایید.
2. **Phase Components:** ساخت کامپوننت‌های اصلی (هدر، سایدبار، کارت‌ها، فرم‌ها) و گرفتن تایید قبل از اتصال داده.
3. **Phase Pages:** پیاده‌سازی صفحات کاربردی (Auth, Dashboard, Customers, Visits, Invoices, Settings) و نمایش هر صفحه برای تایید ظاهری.
4. **Phase Interactions:** افزودن منطق، فرم‌ها، ولیدیشن و تعاملات مطابق نیاز.

## استقرار روی سی‌پنل
- ساخت فایل `server.js` برای اجرای Next.js روی پورت 3124.
- استفاده از دستور `node server.js` در سی‌پنل (Application Manager یا cron).
- تنظیم Route دامنه اصلی به پورت 3124 (ریورس پراکسی یا تنظیمات داخلی هاست).
- Management فایل‌های `.env` روی سرور بدون انتشار در مخزن.

## متغیرهای محیطی پیشنهادی
- `NODE_ENV`
- `PORT` (3124)
- `NEXT_PUBLIC_SITE_URL` (`https://tamirban1.ir`)
- `MONGODB_URI` (اتصال داده‌شده)
- کلیدهای سرویس پیامکی (پس از انتخاب سرویس)
- تنظیمات OTP (timeout, max attempts)

## خروجی‌های مورد انتظار
- مخزن Clean Next.js + Tailwind + TypeScript با ساختار آماده برای فرانت و بک‌اند.
- فایل `server.js` برای run-time در سی‌پنل.
- پوشه `postman/` شامل کالکشن و محیط.
- `.env.example` با مقادیر نمونه.
- مستندات نهایی (این فایل + todo.md) برای ردیابی پیشرفت.
- راهنمای جامع انتقال به Flutter/Android (حاوی چک‌لیست فازبندی شده، توضیحات معماری، نمونه درخواست‌های API، دسترسی‌ها و دارایی‌های UI استاتیک).

## گام‌های اولیه پیشنهادی
1. ایجاد پروژه جدید Next.js با TypeScript و Tailwind (`npx create-next-app@latest --ts --tailwind`).
2. تنظیم فونت ایران یکان، RTL، Layout پایه و گرفتن تایید کارفرما.
3. تعریف ساختار پوشه‌ها (app/, lib/, modules/, postman/، ...).
4. پیاده‌سازی `server.js` و تست لوکال روی پورت 3124.
5. کانفیگ `.env` و اتصال به MongoDB تستی.
6. تعریف اسکیمای MongoDB و شروع ماژول احراز هویت با OTP (حالت تست) شامل رمزنگاری OTP با `bcrypt` و صدور `JWT`.

## نکات معماری برای احراز هویت
- **رمزنگاری OTP:** کدهای تائید صرفاً در حافظه/دیتابیس با `bcrypt` ذخیره شوند تا در صورت نشت اطلاعات قابل سوءاستفاده نباشند.
- **توکن JWT:** پس از تایید OTP، توکن‌های دسترسی و رفرش (در صورت نیاز) با امضای مناسب صادر و در سمت کلاینت نگهداری شوند.
- **گزینه‌های جایگزین:** در صورت نیاز به سشن‌های سروری، می‌توان از NextAuth با آداپتور Credentials + Providers سفارشی برای OTP استفاده کرد؛ با این حال، رویکرد JWT + bcrypt ساده‌تر و کنترل‌پذیرتر برای API مشترک وب/اندروید است.

## نقشه انتقال به Flutter/Android
- پس از تکمیل کامل ماژول‌های وب (فازهای 0 تا 7)، باید یک فایل راهنما با عنوان پیشنهادی `docs/flutter-handoff.md` ایجاد شود که شامل موارد زیر باشد:
  - خلاصه معماری REST API، مسیرها، مدل داده و قرارداد پاسخ‌ها.
  - چک‌لیست فازبندی شده برای توسعه Flutter (Bootstrap، احراز هویت، ماژول‌ها، تست، استقرار).
  - دارایی‌های UI شامل طرح‌های استاتیک (Snapshot صفحات تایید شده)، Style Guide (رنگ‌ها، فونت‌ها، Spacing).
  - دسترسی‌ها و نقش‌ها، منطق تفویض در اپ، و نیازهای امنیتی (مدیریت JWT، Refresh Token).
  - سناریوهای تست و پرامپت‌های پیشنهادی برای تولید نسخه‌های بعدی یا استفاده در ابزارهای طراحی.
- پیش از شروع فاز Flutter باید صحت دیتابیس، روابط و سناریوهای انتها به انتها در CRM (ایجاد کاربر، ثبت ویزیت، صدور پیش‌فاکتور، گزارش‌گیری) به طور کامل تایید شود.
- این راهنما باید منبع اصلی تیم موبایل باشد و بعد از هر تغییر اصلی در وب، به‌روز شود تا همسویی دو پلتفرم حفظ گردد.

این سند باید همراه با `todo.md` عمل کند؛ هرگاه تغییری در دامنه پروژه یا الزامات رخ دهد، هر دو فایل باید همگام‌سازی شوند.


